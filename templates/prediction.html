<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>STOX - Stock Price Prediction Results</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    
    <style>
      * { 
        margin: 0; 
        padding: 0; 
        box-sizing: border-box; 
      }
      
      body {
        background: #000;
        color: #fff;
        font-family: 'Inter', sans-serif;
        min-height: 100vh;
        overflow-x: hidden;
      }

      .container {
        max-width: 1400px !important;
        padding: 2rem 1.5rem;
      }

      
      /* Header Section */
      .page-header {
        background: linear-gradient(135deg, rgba(23,59,187,0.13) 0%, rgba(255,255,255,0.05) 100%);
        border-radius: 1.7rem;
        box-shadow: 0 6px 32px 0 rgba(23,59,187,0.10), 0 1.5px 8px 0 rgba(23,59,187,0.08) inset;
        border: 1.5px solid rgba(255,255,255,0.13);
        padding: 2rem;
        margin-bottom: 2.5rem;
        position: relative;
        overflow: hidden;
      }
      
      .page-header::before {
        content: '';
        display: block;
        position: absolute;
        top: 0; left: 0; right: 0;
        height: 7px;
        background: linear-gradient(90deg, #173bbb 0%, #2563eb 100%);
        border-radius: 1.7rem 1.7rem 0 0;
        z-index: 2;
      }

      .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #fff;
        letter-spacing: -1px;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 16px rgba(23,59,187,0.10);
      }

      .page-title .stock-symbol {
        background: linear-gradient(90deg, rgb(23,5,187) 0%, #2563eb 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-transform: uppercase;
      }

      .page-subtitle {
        color: #bfc9d1;
        font-size: 1.1rem;
        margin-bottom: 0;
      }

      /* Back Button */
      .btn-back {
        background: rgba(255,255,255,0.08) !important;
        border: 1.5px solid rgba(255,255,255,0.13);
        color: #fff !important;
        border-radius: 0.9rem;
        font-weight: 600;
        padding: 0.8rem 1.6rem;
        transition: all 0.2s ease;
        text-decoration: none !important;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }

      .btn-back:hover {
        background: rgba(23,59,187,0.15) !important;
        border-color: rgba(23,59,187,0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px 0 rgba(23,59,187,0.18);
        color: #fff !important;
      }

      /* Main Chart Card */
      .chart-card {
        background: linear-gradient(135deg, rgba(23,59,187,0.13) 0%, rgba(255,255,255,0.05) 100%);
        border-radius: 1.7rem;
        box-shadow: 0 6px 32px 0 rgba(23,59,187,0.10), 0 1.5px 8px 0 rgba(23,59,187,0.08) inset;
        border: 1.5px solid rgba(255,255,255,0.13);
        overflow: hidden;
        margin-bottom: 2.5rem;
        transition: box-shadow 0.2s, transform 0.2s;
      }

      .chart-card:hover {
        box-shadow: 0 10px 40px 0 rgba(23,59,187,0.18), 0 2px 12px 0 rgba(23,59,187,0.10) inset;
        transform: translateY(-2px);
      }

      .chart-header {
        background: linear-gradient(90deg, #173bbb 0%, #2563eb 100%);
        color: #fff;
        padding: 1.5rem 2rem;
        font-weight: 700;
        font-size: 1.25rem;
        border: none;
        margin: 0;
      }

      .chart-toggle-btn {
        background: rgba(255,255,255,0.15) !important;
        border: 1px solid rgba(255,255,255,0.2);
        color: #fff !important;
        border-radius: 0.7rem;
        font-weight: 600;
        padding: 0.6rem 1.4rem;
        transition: all 0.2s ease;
      }

      .chart-toggle-btn:hover {
        background: rgba(255,255,255,0.25) !important;
        transform: translateY(-1px);
        color: #fff !important;
      }

      /* Custom Plot Form */
      .custom-plot-form {
        background: rgba(0,0,0,0.3);
        border-top: 1px solid rgba(255,255,255,0.08);
        padding: 2rem;
      }

      .form-label {
        color: #bfc9d1;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
      }

      .form-control {
        color: #fff !important;
        background: #111 !important;
        border: 1.5px solid rgba(23,59,187,0.18);
        border-radius: 0.9rem;
        font-size: 1rem;
        padding: 0.7rem 1rem;
        transition: border 0.2s, box-shadow 0.2s;
        box-shadow: 0 1.5px 8px 0 rgba(23,59,187,0.06) inset;
      }

      .form-control:focus {
        border: 2px solid #173bbb;
        background: rgba(23,59,187,0.11) !important;
        color: #fff !important;
        box-shadow: 0 2px 12px 0 rgba(23,59,187,0.13) inset;
        outline: none;
      }

      .btn-primary {
        background: rgb(23,5,187) !important;
        border: none;
        border-radius: 0.9rem;
        font-weight: 700;
        font-size: 1rem;
        padding: 0.8rem 1.6rem;
        transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 2px 8px 0 rgba(23,59,187,0.10);
      }

      .btn-primary:hover {
        background: #2563eb !important;
        transform: translateY(-2px) scale(1.03);
        box-shadow: 0 4px 16px 0 rgba(23,59,187,0.18);
      }

      .btn-primary:disabled {
        background: rgba(23,59,187,0.5) !important;
        transform: none;
        box-shadow: none;
      }

      /* Plot Container */
      .plot-container {
        padding: 2rem;
        min-height: 600px;
        background: rgba(0,0,0,0.2);
        border-radius: 0 0 1.7rem 1.7rem;
      }

      .custom-plot-container {
        padding: 2rem;
        min-height: 600px;
        background: rgba(0,0,0,0.2);
        border-radius: 0 0 1.7rem 1.7rem;
        display: none;
      }

      /* Alert Styles */
      .alert {
        border-radius: 0.9rem;
        border: 1px solid rgba(255,255,255,0.1);
        font-weight: 500;
      }

      .alert-info {
        background: linear-gradient(135deg, rgba(23,59,187,0.15) 0%, rgba(37,99,235,0.1) 100%);
        color: #93c5fd;
        border-color: rgba(23,59,187,0.3);
      }

      .alert-danger {
        background: linear-gradient(135deg, rgba(239,68,68,0.15) 0%, rgba(220,38,38,0.1) 100%);
        color: #fca5a5;
        border-color: rgba(239,68,68,0.3);
      }
      
      /* Data Tables Section */
      .tables-section {
        margin-top: 2.5rem;
      }

      .section-title {
        font-size: 2rem;
        font-weight: 700;
        color: #fff;
        text-align: center;
        margin-bottom: 2rem;
        letter-spacing: -0.5px;
      }

      .table-card {
        background: linear-gradient(135deg, rgba(23,59,187,0.13) 0%, rgba(255,255,255,0.05) 100%);
        border-radius: 1.7rem;
        box-shadow: 0 6px 32px 0 rgba(23,59,187,0.10), 0 1.5px 8px 0 rgba(23,59,187,0.08) inset;
        border: 1.5px solid rgba(255,255,255,0.13);
        overflow: hidden;
        margin-bottom: 2rem;
        transition: box-shadow 0.2s, transform 0.2s;
      }

      .table-card:hover {
        box-shadow: 0 10px 40px 0 rgba(23,59,187,0.18), 0 2px 12px 0 rgba(23,59,187,0.10) inset;
        transform: translateY(-2px);
      }

      .table-header {
        background: linear-gradient(90deg, #173bbb 0%, #2563eb 100%);
        color: #fff;
        padding: 1.2rem 2rem;
        font-weight: 700;
        font-size: 1.1rem;
        border: none;
        margin: 0;
        text-align: center;
      }

      .table-body {
        padding: 1.5rem;
        background: rgba(0,0,0,0.2);
      }

      /* Custom DataTable Styles */
      .table {
        color: #fff !important;
        background: transparent !important;
      }

      .table thead th {
        border-color: rgba(255,255,255,0.1) !important;
        background: rgba(23,59,187,0.1) !important;
        color: #fff !important;
        font-weight: 600;
        font-size: 0.95rem;
        padding: 1rem 0.75rem;
      }

      .table tbody td {
        border-color: rgba(255,255,255,0.05) !important;
        background: transparent !important;
        color: #bfc9d1 !important;
        padding: 0.8rem 0.75rem;
        font-size: 0.9rem;
      }

      .table-striped > tbody > tr:nth-of-type(odd) > td {
        background: rgba(255,255,255,0.02) !important;
      }

      .table-hover > tbody > tr:hover > td {
        background: rgba(23,59,187,0.08) !important;
        color: #fff !important;
      }

      /* Difference Column Colors */
      .text-success {
        color: #22c55e !important;
        font-weight: 600;
      }

      .text-danger {
        color: #ef4444 !important;
        font-weight: 600;
      }

      /* DataTables Controls */
      .dataTables_wrapper {
        color: #fff !important;
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button {
        background: rgba(255,255,255,0.05) !important;
        border: 1px solid rgba(255,255,255,0.1) !important;
        color: #bfc9d1 !important;
        border-radius: 0.5rem;
        margin: 0 0.2rem;
        padding: 0.4rem 0.8rem;
        transition: all 0.2s ease;
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: rgba(23,59,187,0.2) !important;
        border-color: rgba(23,59,187,0.3) !important;
        color: #fff !important;
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: linear-gradient(90deg, #173bbb 0%, #2563eb 100%) !important;
        border-color: #173bbb !important;
        color: #fff !important;
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
        background: rgba(255,255,255,0.02) !important;
        border-color: rgba(255,255,255,0.05) !important;
        color: rgba(191,201,209,0.5) !important;
      }

      /* Override any Bootstrap pagination styles that might interfere */
      .dataTables_wrapper .dataTables_paginate .paginate_button a {
        background: transparent !important;
        color: inherit !important;
        border: none !important;
        text-decoration: none !important;
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button a:hover {
        background: transparent !important;
        color: inherit !important;
      }

      .dataTables_wrapper .dataTables_info {
        color: #bfc9d1 !important;
        font-size: 0.9rem;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }
        
        .page-header {
          padding: 1.5rem;
        }
        
        .page-title {
          font-size: 2rem;
        }
        
        .custom-plot-form {
          padding: 1.5rem;
        }
        
        .plot-container,
        .custom-plot-container {
          padding: 1rem;
          min-height: 400px;
        }
        
        .table-body {
          padding: 1rem;
        }
        
        .btn-back {
          padding: 0.6rem 1.2rem;
          font-size: 0.9rem;
        }
      }

      @media (max-width: 576px) {
        .page-title {
          font-size: 1.8rem;
        }
        
        .section-title {
          font-size: 1.6rem;
        }
      }

      /* Plotly Override */
      .js-plotly-plot,
      .plotly-graph-div {
        background: transparent !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header Section -->
      <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1 class="page-title">
              Stock Prediction: <span class="stock-symbol">{{ stock_symbol }}</span>
            </h1>
          </div>
          <a href="/app" class="btn-back">
            <i class="bi bi-arrow-left"></i>
            Back to Dashboard
          </a>
        </div>
      </div>

      <!-- Main Chart Section -->
      <div class="chart-card">
        <div class="chart-header d-flex justify-content-between align-items-center">
          <h2 class="mb-0">Stock Price Visualization</h2>
          <button
            class="chart-toggle-btn"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#customPlotForm"
            aria-expanded="false"
            aria-controls="customPlotForm"
          >
            <i class="bi bi-gear-fill me-2"></i>
            Customize Plot
          </button>
        </div>

        <!-- Custom Plot Form (Collapsible) -->
        <div class="collapse" id="customPlotForm">
          <div class="custom-plot-form">
            <div class="row g-4 align-items-end">
              <div class="col-lg-4 col-md-6">
                <label for="historicalDays" class="form-label">
                  <i class="bi bi-clock-history me-1"></i>
                  Historical Days
                </label>
                <input
                  type="number"
                  class="form-control"
                  id="historicalDays"
                  value="15"
                  min="1"
                  max="365"
                  placeholder="Enter days"
                />
              </div>
              <div class="col-lg-4 col-md-6">
                <label for="predictionDays" class="form-label">
                  <i class="bi bi-graph-up-arrow me-1"></i>
                  Prediction Days
                </label>
                <input
                  type="number"
                  class="form-control"
                  id="predictionDays"
                  value="30"
                  min="1"
                  max="90"
                  placeholder="Enter days"
                />
              </div>
              <div class="col-lg-4 col-md-12">
                <button
                  type="button"
                  id="updatePlot"
                  class="btn btn-primary w-100"
                >
                  <i class="bi bi-arrow-clockwise me-2"></i>
                  Generate Custom Plot
                </button>
              </div>
            </div>
            
            <!-- Alert for custom plot status -->
            <div id="customPlotAlert" class="alert alert-info mt-3 d-none">
              <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <span>Generating custom plot... Please wait.</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Plot Display Area -->
        <div class="plot-container" id="plotContainer">
          <div id="defaultPlot">
            {% if plot_html %} 
              {{ plot_html|safe }} 
            {% else %}
              <div class="alert alert-info text-center">
                <i class="bi bi-info-circle me-2"></i>
                No plot data available
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Custom Plot Container -->
        <div class="custom-plot-container" id="customPlotContainer">
          <div class="custom-plot-placeholder"></div>
        </div>
      </div>

      <!-- Data Tables Section -->
      <div id="prediction-tables" class="tables-section" style="display: none">
        <div class="row g-4">
          <!-- Section Title Above Both Tables -->
          <div class="col-12">
            <h2 class="section-title">
              <i class="bi bi-table me-2"></i>
              Prediction Data Analysis
            </h2>
          </div>
          
          <!-- Historical Data Table -->
          <div class="col-lg-6">
            <div class="table-card">
              <div class="table-header">
                <i class="bi bi-clock-history me-2"></i>
                Historical Predictions
              </div>
              <div class="table-body">
                <div class="table-responsive">
                  <table id="historical-table" class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th><i class="bi bi-calendar3 me-1"></i>Date</th>
                        <th><i class="bi bi-graph-up me-1"></i>Actual</th>
                        <th><i class="bi bi-cpu me-1"></i>Predicted</th>
                        <th><i class="bi bi-arrow-up-down me-1"></i>Difference</th>
                        <th><i class="bi bi-percent me-1"></i>Accuracy</th>
                      </tr>
                    </thead>
                    <tbody id="historical-tbody">
                      <!-- Data will be loaded dynamically -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Future Predictions Table -->
          <div class="col-lg-6">
            <div class="table-card">
              <div class="table-header">
                <i class="bi bi-graph-up-arrow me-2"></i>
                Future Predictions
              </div>
              <div class="table-body">
                <div class="table-responsive">
                  <table id="future-table" class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th><i class="bi bi-calendar-plus me-1"></i>Date</th>
                        <th><i class="bi bi-currency-dollar me-1"></i>Predicted Price</th>
                      </tr>
                    </thead>
                    <tbody id="future-tbody">
                      <!-- Data will be loaded dynamically -->
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
    <!-- Plotly.js for interactive charts -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
      // Initialize with empty arrays since we'll only populate these from custom plot
      let resultsData = [];
      let futureData = [];

      /*
      // Original code to parse JSON data - now handled dynamically with custom plot
      try {
        resultsData = JSON.parse("{{ results|safe }}");
        futureData = JSON.parse("{{ future_results|safe }}");
      } catch (e) {
        console.error("Error parsing JSON data:", e);
        resultsData = [];
        futureData = [];
      }
      */

        // Show error alert
        const alertDiv = document.createElement("div");
        alertDiv.className = "alert alert-danger";
        alertDiv.textContent =
          "Error loading prediction data. Please try again.";
        document.querySelector(".container").prepend(alertDiv);
      }

      $(document).ready(function () {
        // Completely hide prediction tables on initial page load
        // They will only be shown when user clicks "Update Plot" for custom plot
        const predictionTables = document.getElementById("prediction-tables");
        if (predictionTables) {
          predictionTables.style.display = "none";
        }

        // Initialize empty DataTables to avoid errors
        try {
          $('#historical-table').DataTable({
            order: [[0, 'desc']],
            pageLength: 10,
            searching: false,
            info: false
          });

          $('#future-table').DataTable({
            order: [[0, 'asc']],
            pageLength: 10,
            searching: false,
            info: false
          });
        } catch (error) {
          console.error("Error initializing empty DataTables:", error);
        }

        /* Original code - no longer needed as tables will be populated dynamically
        // Populate historical data table
        const historicalBody = document.getElementById("historical-tbody");
        resultsData.forEach((item) => {
          const row = document.createElement("tr");

          // Safely parse the date
          let formattedDate;
          try {
            const date = new Date(item.Date);
            formattedDate =
              date instanceof Date && !isNaN(date)
                ? date.toLocaleDateString()
                : item.Date; // Use the string directly if parsing fails
          } catch (e) {
            formattedDate = item.Date;
          }

          // Safely parse numerical values
          const actual = !isNaN(parseFloat(item.Actual))
            ? parseFloat(item.Actual).toFixed(2)
            : "N/A";
          const predicted = !isNaN(parseFloat(item.Predicted))
            ? parseFloat(item.Predicted).toFixed(2)
            : "N/A";

          // Calculate difference and accuracy only if both values are numerical
          let diff = "N/A";
          let accuracy = "N/A";
          let diffClass = "";

          if (
            !isNaN(parseFloat(item.Actual)) &&
            !isNaN(parseFloat(item.Predicted))
          ) {
            diff = (
              parseFloat(item.Predicted) - parseFloat(item.Actual)
            ).toFixed(2);
            accuracy = (
              100 - Math.abs((diff / parseFloat(item.Actual)) * 100)
            ).toFixed(2);
            diffClass = parseFloat(diff) > 0 ? "text-success" : "text-danger";
          }

          row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${actual}</td>
                    <td>${predicted}</td>
                    <td class="${diffClass}">${diff}</td>
                    <td>${accuracy}${accuracy !== "N/A" ? "%" : ""}</td>
                `;
          historicalBody.appendChild(row);
        });

        // Populate future data table
        const futureBody = document.getElementById("future-tbody");
        futureData.forEach((item) => {
          const row = document.createElement("tr");

          // Safely parse the date
          let formattedDate;
          try {
            const date = new Date(item.Date);
            formattedDate =
              date instanceof Date && !isNaN(date)
                ? date.toLocaleDateString()
                : item.Date; // Use the string directly if parsing fails
          } catch (e) {
            formattedDate = item.Date;
          }

          // Safely parse predicted value
          const predicted = !isNaN(parseFloat(item.Predicted))
            ? parseFloat(item.Predicted).toFixed(2)
            : "N/A";

          row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${predicted}</td>
                `;
          futureBody.appendChild(row);
        });

        // Initialize DataTables
        $("#historical-table").DataTable({
          order: [[0, "desc"]],
          pageLength: 10,
        });

        $("#future-table").DataTable({
          order: [[0, "asc"]],
          pageLength: 10,
        });
        */
      });
    </script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>

    <!-- Custom prediction script -->
    <script>
      // Handle custom prediction plot
      document.addEventListener("DOMContentLoaded", function () {
        const updatePlotBtn = document.getElementById("updatePlot");
        const historicalDaysInput = document.getElementById("historicalDays");
        const predictionDaysInput = document.getElementById("predictionDays");
        const customPlotAlert = document.getElementById("customPlotAlert");
        const customPlotContainer = document.getElementById(
          "customPlotContainer"
        );
        const plotContainer = document.getElementById("plotContainer");
        const defaultPlot = document.getElementById("defaultPlot");

        // Initial check of DOM elements (development logging only)
        /*
        console.log("DOM elements loaded:", {
          updatePlotBtn: !!updatePlotBtn,
          historicalDaysInput: !!historicalDaysInput,
          predictionDaysInput: !!predictionDaysInput,
          customPlotAlert: !!customPlotAlert,
          customPlotContainer: !!customPlotContainer,
          plotContainer: !!plotContainer,
          defaultPlot: !!defaultPlot,
        });
        */

        // Create a function to handle plot rendering
        function createPlotlyPlot(plotData, container) {
          try {
            // Clear the container
            container.innerHTML = "";

            // Create plot container
            const plotContainer = document.createElement("div");
            plotContainer.style.width = "100%";
            plotContainer.style.height = "600px";
            container.appendChild(plotContainer);

            // Parse the HTML to extract the Plotly data and layout
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = plotData;

            // Try to evaluate any script content from the HTML
            const scriptContent = tempDiv.querySelector("script");
            if (scriptContent) {
              // Create and execute the script in the global context
              const scriptEl = document.createElement("script");
              scriptEl.textContent = scriptContent.textContent;
              document.head.appendChild(scriptEl);
              console.log("Script from Plotly HTML executed");
            } else {
              console.log("No script found in Plotly HTML");
            }

            // If direct script execution doesn't work, insert the HTML directly
            container.innerHTML = plotData;
          } catch (error) {
            console.error("Error creating Plotly plot:", error);
            container.innerHTML = `<div class="alert alert-danger">Error rendering plot: ${error.message}</div>`;
          }
        }

        if (updatePlotBtn) {
          updatePlotBtn.addEventListener("click", function () {
            console.log("Update Plot button clicked");

            // Get input values
            const historicalDays = parseInt(historicalDaysInput.value) || 15;
            const predictionDays = parseInt(predictionDaysInput.value) || 30;
            console.log("Input values:", historicalDays, predictionDays);

            // Validate input
            if (historicalDays < 1) {
              alert("Historical days must be at least 1");
              return;
            }

            if (predictionDays < 1 || predictionDays > 90) {
              alert("Prediction days must be between 1 and 90");
              return;
            }

            // Show loading message with spinner
            customPlotAlert.innerHTML = `
              <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <span>Generating custom plot... Please wait.</span>
              </div>
            `;
            customPlotAlert.classList.remove("d-none", "alert-danger");
            customPlotAlert.classList.add("alert-info", "d-block");

            // Also update the button to show loading state
            updatePlotBtn.disabled = true;
            updatePlotBtn.innerHTML = `
              <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              Generating...
            `;

            // Make AJAX request
            console.log("Sending request to /custom_prediction");
            fetch("/custom_prediction", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                historical_days: historicalDays,
                prediction_days: predictionDays,
                stock_symbol: "{{ stock_symbol }}",
              }),
            })
              .then((response) => {
                console.log("Response received:", response.status);
                return response.json();
              })
              .then((data) => {
                console.log("Data received:", data.success, data.message);

                if (data.success) {
                  // Hide default plot and show custom plot container
                  if (defaultPlot) defaultPlot.style.display = "none";
                  if (plotContainer) plotContainer.style.display = "none";

                  // Create a fresh container for the custom plot to avoid any rendering issues
                  if (customPlotContainer) {
                    // First clear the container
                    customPlotContainer.innerHTML = "";

                    // Create a new div for the plot
                    const newPlotDiv = document.createElement("div");
                    newPlotDiv.id = "custom-plotly-" + new Date().getTime();
                    newPlotDiv.className = "plotly-container";
                    newPlotDiv.style.paddingBottom = "40px"; // Add more padding for date labels
                    newPlotDiv.style.marginBottom = "20px"; // Add margin for better spacing
                    newPlotDiv.style.paddingTop = "20px"; // Add top padding for better layout
                    customPlotContainer.appendChild(newPlotDiv);

                    // Make the container visible - important!
                    customPlotContainer.style.display = "block";

                    // Force redraw to make sure the chart renders properly
                    setTimeout(() => {
                      window.dispatchEvent(new Event("resize"));
                    }, 100);

                    // Check if we actually received any HTML content
                    console.log(
                      "Plot HTML content type:",
                      typeof data.plot_html
                    );
                    console.log(
                      "Plot HTML content first 100 chars:",
                      data.plot_html
                        ? data.plot_html.substring(0, 100)
                        : "EMPTY"
                    );

                    // Insert the HTML into the new div
                    if (data.plot_html && data.plot_html.length > 0) {
                      // Just use direct HTML injection for Plotly
                      // This preserves any script tags and initialization code
                      newPlotDiv.innerHTML = data.plot_html;
                      console.log("Injected Plotly HTML directly");

                      // Execute any script tags that might have been added
                      const scripts = newPlotDiv.getElementsByTagName("script");
                      for (let i = 0; i < scripts.length; i++) {
                        const script = scripts[i];
                        const newScript = document.createElement("script");
                        // Copy all attributes
                        Array.from(script.attributes).forEach((attr) => {
                          newScript.setAttribute(attr.name, attr.value);
                        });
                        // Copy content
                        newScript.innerHTML = script.innerHTML;
                        // Replace the old script with the new one
                        script.parentNode.replaceChild(newScript, script);
                      }

                      // Add a small delay then try to modify the Plotly layout for better visibility
                      setTimeout(() => {
                        try {
                          const plotlyGraphs =
                            document.querySelectorAll(".js-plotly-plot");
                          if (plotlyGraphs.length > 0) {
                            plotlyGraphs.forEach((plot) => {
                              // Get the plot's context
                              if (window.Plotly && plot._context) {
                                // Update layout for better spacing and readability
                                const updateLayout = {
                                  margin: { t: 50, r: 50, b: 80, l: 60 },
                                  height: 600, // Make plot taller
                                  xaxis: {
                                    tickformat: "%Y-%m", // Show only year-month format for less cluttered labels
                                    tickangle: 45,
                                    tickfont: {
                                      size: 13,
                                      family: "Arial, sans-serif",
                                    }, // Larger font size
                                    title: {
                                      text: "Date",
                                      font: {
                                        size: 14,
                                        family: "Arial, sans-serif",
                                      },
                                    },
                                    gridcolor: "#f0f0f0",
                                  },
                                  yaxis: {
                                    titlefont: {
                                      size: 14,
                                      family: "Arial, sans-serif",
                                    },
                                    tickfont: {
                                      size: 13,
                                      family: "Arial, sans-serif",
                                    },
                                    title: {
                                      text: "Price",
                                      font: {
                                        size: 14,
                                        family: "Arial, sans-serif",
                                      },
                                    },
                                    gridcolor: "#f0f0f0",
                                  },
                                  plot_bgcolor: "#ffffff",
                                  paper_bgcolor: "#ffffff",
                                };
                                window.Plotly.relayout(plot, updateLayout);
                              }
                            });
                          }
                        } catch (e) {
                          console.log("Error customizing plot layout:", e);
                        }
                      }, 500);

                      console.log(
                        "Custom plot HTML injected into fresh container, length:",
                        data.plot_html.length
                      );

                      // Debug output of container
                      console.log(
                        "Container now contains:",
                        newPlotDiv.childNodes.length,
                        "child nodes"
                      );
                      console.log(
                        "Container visibility:",
                        getComputedStyle(customPlotContainer).display
                      );
                    } else {
                      console.error("Received empty plot HTML");
                      newPlotDiv.innerHTML =
                        "<div class='alert alert-warning'>Error: Received empty plot data</div>";
                    }
                  } else {
                    console.error("customPlotContainer element not found");
                    // As a fallback, replace the entire plot container
                    if (plotContainer) {
                      plotContainer.innerHTML = data.plot_html;
                      console.log("Fallback: replaced entire plot container");
                    }
                  }

                  // Hide alert and restore button
                  if (customPlotAlert) customPlotAlert.classList.add("d-none");
                  // Restore the button
                  updatePlotBtn.disabled = false;
                  updatePlotBtn.innerHTML = "Update Plot";

                  // Update the tables with the received data
                  updatePredictionTables(
                    data.historical_data,
                    data.future_data
                  );

                  // Show the prediction tables section
                  const predictionTables =
                    document.getElementById("prediction-tables");
                  if (predictionTables) {
                    predictionTables.style.display = "flex";
                  } else {
                    console.error("Prediction tables container not found");
                  }

                  // Scroll to make sure tables are visible
                  setTimeout(() => {
                    const customPlotContainer = document.getElementById(
                      "customPlotContainer"
                    );
                    if (customPlotContainer) {
                      customPlotContainer.scrollIntoView({
                        behavior: "smooth",
                        block: "nearest",
                      });
                    }
                  }, 100);

                  // Force Plotly to resize the plot to fit the container
                  if (window.Plotly) {
                    // Use multiple timeouts to ensure rendering completes
                    setTimeout(() => {
                      const plotlyElements = document.querySelectorAll(
                        ".js-plotly-plot, .plotly-graph-div"
                      );
                      if (plotlyElements.length > 0) {
                        console.log(
                          "Resizing Plotly plots:",
                          plotlyElements.length
                        );
                        plotlyElements.forEach((plot) => {
                          try {
                            window.Plotly.Plots.resize(plot);
                            console.log("Successfully resized plot:", plot.id);
                          } catch (e) {
                            console.error("Error resizing plot:", e);
                          }
                        });
                      } else {
                        console.warn("No Plotly elements found to resize");
                      }

                      // Try again a bit later to ensure rendering
                      setTimeout(() => {
                        const plotlyElements = document.querySelectorAll(
                          ".js-plotly-plot, .plotly-graph-div"
                        );
                        if (plotlyElements.length > 0) {
                          console.log("Final resize attempt for Plotly plots");
                          plotlyElements.forEach((plot) => {
                            try {
                              window.Plotly.Plots.resize(plot);
                            } catch (e) {
                              console.error("Error in final resize:", e);
                            }
                          });
                        }
                      }, 500);
                    }, 100);
                  } else {
                    console.error(
                      "Plotly library not loaded! Adding script tag dynamically."
                    );
                    // Try to load Plotly dynamically as a fallback
                    const plotlyScript = document.createElement("script");
                    plotlyScript.src =
                      "https://cdn.plot.ly/plotly-latest.min.js";
                    plotlyScript.onload = () => {
                      console.log(
                        "Plotly loaded dynamically, refreshing plot..."
                      );
                      setTimeout(() => {
                        document
                          .querySelectorAll(".plotly-graph-div")
                          .forEach((plot) => {
                            window.Plotly.Plots.resize(plot);
                          });
                      }, 300);
                    };
                    document.head.appendChild(plotlyScript);
                  }
                } else {
                  // Show error
                  if (customPlotAlert) {
                    customPlotAlert.textContent = data.message;
                    customPlotAlert.classList.remove("alert-info");
                    customPlotAlert.classList.add("alert-danger", "d-block");
                  } else {
                    console.error("Error:", data.message);
                    alert("Error: " + data.message);
                  }

                  // Restore the button
                  updatePlotBtn.disabled = false;
                  updatePlotBtn.innerHTML = "Update Plot";
                }
              })
              .catch((error) => {
                console.error("Error in fetch operation:", error);
                if (customPlotAlert) {
                  customPlotAlert.textContent =
                    "Error generating custom plot. Please try again.";
                  customPlotAlert.classList.remove("alert-info", "d-none");
                  customPlotAlert.classList.add("alert-danger", "d-block");
                } else {
                  alert("Error generating custom plot: " + error.message);
                }

                // Restore the button
                updatePlotBtn.disabled = false;
                updatePlotBtn.innerHTML = "Update Plot";
              });
          });
        } else {
          console.error("Update Plot button not found");
        }

        // Ensure plot is visible without scrolling
        window.scrollTo(0, 0);

        // Initialize the default plot and update x-axis format
        if (window.Plotly) {
          // First resize attempt
          const plotlyElements = document.querySelectorAll(
            ".js-plotly-plot, .plotly-graph-div"
          );
          if (plotlyElements.length > 0) {
            console.log("Initializing and resizing Plotly plots");
            plotlyElements.forEach((plot) => {
              try {
                // Update the layout to show only year on x-axis and make the plot more readable
                window.Plotly.relayout(plot, {
                  margin: { t: 50, r: 50, b: 80, l: 60 },
                  height: 600,
                  xaxis: {
                    tickformat: "%Y-%m", // Show only year-month format
                    tickangle: 45,
                    tickfont: { size: 13, family: "Arial, sans-serif" },
                    title: {
                      text: "Date",
                      font: { size: 14, family: "Arial, sans-serif" },
                    },
                    gridcolor: "#f0f0f0",
                  },
                  yaxis: {
                    titlefont: { size: 14, family: "Arial, sans-serif" },
                    tickfont: { size: 13, family: "Arial, sans-serif" },
                    title: {
                      text: "Price",
                      font: { size: 14, family: "Arial, sans-serif" },
                    },
                    gridcolor: "#f0f0f0",
                  },
                  plot_bgcolor: "#ffffff",
                  paper_bgcolor: "#ffffff",
                });

                // Resize the plot
                window.Plotly.Plots.resize(plot);
              } catch (e) {
                console.error("Error initializing plot:", e);
              }
            });
          }

          // Multiple resize attempts to ensure proper rendering
          setTimeout(() => {
            const plotlyElements = document.querySelectorAll(
              ".js-plotly-plot, .plotly-graph-div"
            );
            plotlyElements.forEach((plot) => {
              try {
                window.Plotly.Plots.resize(plot);
              } catch (e) {}
            });
          }, 100);

          setTimeout(() => {
            const plotlyElements = document.querySelectorAll(
              ".js-plotly-plot, .plotly-graph-div"
            );
            plotlyElements.forEach((plot) => {
              try {
                window.Plotly.Plots.resize(plot);
              } catch (e) {}
            });
          }, 500);
        }

        // Function to update the prediction tables with data from the server
        function updatePredictionTables(historicalData, futureData) {
          console.log(
            "Updating prediction tables with data:",
            "Historical:",
            historicalData?.length || 0,
            "Future:",
            futureData?.length || 0
          );

          // Clear existing table data
          const historicalTbody = document.getElementById("historical-tbody");
          const futureTbody = document.getElementById("future-tbody");

          if (historicalTbody) historicalTbody.innerHTML = "";
          if (futureTbody) futureTbody.innerHTML = "";

          // Populate historical data table if data is available
          if (historicalData && historicalData.length > 0 && historicalTbody) {
            historicalData.forEach((item) => {
              const row = document.createElement("tr");

              try {
                // Format the values - handle potential errors with safe parsing
                const formattedDate = item.Date || "";
                const actual = !isNaN(parseFloat(item.Actual))
                  ? parseFloat(item.Actual).toFixed(2)
                  : "0.00";
                const predicted = !isNaN(parseFloat(item.Predicted))
                  ? parseFloat(item.Predicted).toFixed(2)
                  : "0.00";
                const diff = !isNaN(parseFloat(item.Difference))
                  ? parseFloat(item.Difference).toFixed(2)
                  : "0.00";
                const accuracy = !isNaN(parseFloat(item.Accuracy))
                  ? parseFloat(item.Accuracy).toFixed(2)
                  : "0.00";

                // Determine if difference is positive or negative
                const diffValue = parseFloat(diff);
                const diffClass = diffValue > 0 ? "text-success" : diffValue < 0 ? "text-danger" : "";

                // Create table row HTML
                row.innerHTML = `
                  <td>${formattedDate}</td>
                  <td>${actual}</td>
                  <td>${predicted}</td>
                  <td class="${diffClass}">${diff}</td>
                  <td>${accuracy}%</td>
                `;
              } catch (error) {
                console.error(
                  "Error formatting historical data row:",
                  error,
                  item
                );
                row.innerHTML = `<td colspan="5" class="text-danger">Error displaying this row</td>`;
              }

              historicalTbody.appendChild(row);
            });
            console.log("Added historical data rows:", historicalData.length);
          } else {
            console.warn("No historical data available to display");
            if (historicalTbody) {
              const noDataRow = document.createElement("tr");
              noDataRow.innerHTML =
                '<td colspan="5" class="text-center">No historical data available</td>';
              historicalTbody.appendChild(noDataRow);
            }
          }

          // Populate future data table if data is available
          if (futureData && futureData.length > 0 && futureTbody) {
            futureData.forEach((item) => {
              const row = document.createElement("tr");

              try {
                // Format the values - handle potential errors with safe parsing
                const formattedDate = item.Date || "";
                const predicted = !isNaN(parseFloat(item.Predicted))
                  ? parseFloat(item.Predicted).toFixed(2)
                  : "0.00";

                // Create table row HTML
                row.innerHTML = `
                  <td>${formattedDate}</td>
                  <td>${predicted}</td>
                `;
              } catch (error) {
                console.error("Error formatting future data row:", error, item);
                row.innerHTML = `<td colspan="2" class="text-danger">Error displaying this row</td>`;
              }

              futureTbody.appendChild(row);
            });
            console.log("Added future data rows:", futureData.length);
          } else {
            console.warn("No future data available to display");
            if (futureTbody) {
              const noDataRow = document.createElement("tr");
              noDataRow.innerHTML =
                '<td colspan="2" class="text-center">No future prediction data available</td>';
              futureTbody.appendChild(noDataRow);
            }
          }

          // Convert tables to DataTables for better user experience
          try {
            // Destroy existing DataTables instances if they exist
            if ($.fn.DataTable.isDataTable("#historical-table")) {
              $("#historical-table").DataTable().destroy();
            }

            if ($.fn.DataTable.isDataTable("#future-table")) {
              $("#future-table").DataTable().destroy();
            }

            // Initialize DataTables with optimized configuration
            $("#historical-table").DataTable({
              order: [[0, "desc"]], // Sort by date descending (newest first)
              pageLength: 10,
              searching: false, // Disable search
              info: false, // Disable showing "1 of X entries"
              responsive: true, // Make table responsive
              lengthChange: false, // Disable page length options
              dom: "tp", // Only show table and pagination controls
              columnDefs: [
                {
                  // Format numbers with thousands separators and 2 decimal places
                  targets: [1, 2, 3],
                  render: function (data, type, row) {
                    if (type === "display" || type === "filter") {
                      return parseFloat(data).toLocaleString("en-US", {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                      });
                    }
                    return data;
                  },
                },
                {
                  // Make date column more readable
                  targets: 0,
                  className: "fw-bold",
                },
                {
                  // Style the difference column for better visibility
                  targets: 3,
                  className: "fw-bold",
                },
              ],
            });

            $("#future-table").DataTable({
              order: [[0, "asc"]], // Sort by date ascending (oldest first)
              pageLength: 10,
              searching: false, // Disable search
              info: false, // Disable showing "1 of X entries"
              responsive: true, // Make table responsive
              lengthChange: false, // Disable page length options
              dom: "tp", // Only show table and pagination controls
              columnDefs: [
                {
                  // Format numbers with thousands separators and 2 decimal places
                  targets: 1,
                  render: function (data, type, row) {
                    if (type === "display" || type === "filter") {
                      return parseFloat(data).toLocaleString("en-US", {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2,
                      });
                    }
                    return data;
                  },
                },
              ],
            });

            // Show the tables container after tables are initialized
            document.getElementById("prediction-tables").style.display = "flex";
            console.log(
              "DataTables successfully initialized and tables container shown"
            );
          } catch (error) {
            console.error("Error initializing DataTables:", error);
          }
        }
      });
    </script>
  </body>
</html>
